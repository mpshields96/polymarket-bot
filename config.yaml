# polymarket-bot configuration
# All tunable params live here. Hard safety floors are enforced in code — config cannot override them.
# ═══════════════════════════════════════════════════════════════

# ── Kalshi platform ────────────────────────────────────────────
kalshi:
  mode: demo                            # Start here. Change to "live" manually (never by code).
  demo_url: https://api.elections.kalshi.com/trade-api/v2
  live_url: https://api.elections.kalshi.com/trade-api/v2
  demo_ws_url: wss://api.elections.kalshi.com
  live_ws_url: wss://api.elections.kalshi.com
  read_rate_limit: 10                   # requests/second (Kalshi limit)
  write_rate_limit: 5                   # requests/second (Kalshi limit)
  request_timeout: 10                   # seconds
  max_retries: 3

# ── Polymarket platform ─────────────────────────────────────────
polymarket:
  enabled: false                        # Enable when off waitlist. Never change automatically.
  clob_url: https://clob.polymarket.com
  gamma_url: https://gamma-api.polymarket.com
  chain_id: 137                         # Polygon mainnet

# ── Data feeds ──────────────────────────────────────────────────
feeds:
  binance_ws_url: wss://stream.binance.us:9443/ws/btcusdt@bookTicker  # @trade has 0 volume on Binance.US
  btc_window_seconds: 60               # Rolling window for move detection
  eth_ws_url: wss://stream.binance.us:9443/ws/ethusdt@bookTicker      # ETH feed — same bookTicker approach
  eth_window_seconds: 60               # Rolling window for ETH move detection
  reconnect_delay: 5                   # Seconds before reconnecting on disconnect

# ── Strategy ────────────────────────────────────────────────────
strategy:
  active: btc_lag                      # Only this. Expand after proven.
  markets:
    - KXBTC15M                         # Kalshi BTC 15-min series ticker (confirmed live)
  eth_markets:
    - KXETH15M                         # Kalshi ETH 15-min series ticker (confirmed live)

  btc_lag:
    # SIGNAL CALIBRATION:
    # A signal fires ONLY when ALL gates pass. The binding constraint is min_edge_pct.
    # At min_edge=8% and a 50¢ Kalshi price: need BTC to move ~0.65% in 60s.
    # (formula: need (btc_move * lag_sensitivity/100) > min_edge + kalshi_fee(price))
    # Typical BTC 60s move: 0.02-0.05% (calm), 0.3-1%+ (volatile/news events).
    # To fire more often: lower min_edge_pct first (e.g. 0.05), not min_btc_move_pct.
    # Do NOT lower thresholds without reviewing 7+ days of paper results first.
    min_btc_move_pct: 0.4              # BTC must move this % in btc_window_seconds
    min_kalshi_lag_cents: 5            # Kalshi price must lag spot by this many cents
    min_minutes_remaining: 5           # Don't enter with < 5 min left in window
    min_edge_pct: 0.08                 # Only trade if edge > 8% (after fees)
    lag_sensitivity: 15.0              # Cents of YES/NO price move implied per 1% BTC move

  btc_drift:
    # SECONDARY strategy — paper-only, collects calibration data.
    # Fires whenever BTC drifts from market-open price (much more frequent than btc_lag).
    # Uses sigmoid probability model + time adjustment from refs/kalshi-btc/strategy.py.
    # Math: need (drift_pct * sensitivity/100) to produce edge > min_edge_pct after fee.
    # Sensitivity=800 confirmed via 30-day backtest: Brier=0.2178 (STRONG), 69.1% accuracy.
    # At sensitivity=800: 0.1% drift → P(YES)≈0.55 → edge≈0.03 at 50¢ market.
    sensitivity: 800.0               # Sigmoid steepness — calibrated from 30d backtest (was 300)
    min_drift_pct: 0.05              # BTC must drift ≥ 0.05% from market open
    min_minutes_remaining: 3.0       # Don't enter with ≤ 3 min left
    min_edge_pct: 0.05               # Only trade if net edge > 5% (after fees)
    time_weight: 0.7                 # How much time remaining blends probability (0=ignore, 1=full)

  eth_lag:
    # ETH lag strategy — paper-only, mirrors btc_lag params initially.
    # ETH is more volatile than BTC; may need lower lag_sensitivity after calibration.
    min_btc_move_pct: 0.4              # ETH must move this % in eth_window_seconds
    min_kalshi_lag_cents: 5
    min_minutes_remaining: 5
    min_edge_pct: 0.08
    lag_sensitivity: 15.0             # Same as BTC until we have calibration data

  eth_drift:
    # ETH drift strategy — paper-only, mirrors btc_drift params initially.
    sensitivity: 800.0
    min_drift_pct: 0.05
    min_minutes_remaining: 3.0
    min_edge_pct: 0.05
    time_weight: 0.7

  orderbook_imbalance:
    # VPIN-lite orderbook imbalance strategy — paper-only, any market.
    # Fires when YES/NO bid depth is lopsided (smart money detection).
    # Theory: large bid imbalance → informed traders are on that side.
    # Reference: PIN model (Easley, Kiefer, O'Hara 1996)
    # Adapted from: vortexpixelz/Kalshi-smart-money (VPIN model)
    min_imbalance_ratio: 0.65     # >65% YES depth → buy YES; <35% → buy NO
    min_total_depth: 50           # Skip thin markets (< 50 total contracts)
    depth_top_n: 10               # Only consider top 10 price levels
    min_edge_pct: 0.05            # 5% edge required after fees
    min_minutes_remaining: 3.0
    signal_scaling: 1.0           # Scale imbalance→probability mapping

  weather:
    # Weather forecast vs Kalshi temperature market strategy — paper-only.
    # Compares Open-Meteo GFS daily high-temp forecast to Kalshi NYC weather markets.
    # Fires when normal-distribution model probability diverges from market price.
    # Theory: weather models (NWP) are typically more accurate than prediction markets
    #         especially 24-48h ahead when market prices reflect outdated info.
    # Reference: jazzmine-p/weather-forecast-automated-trading (LSTM + NCEI, +20% in 1 week)
    city: nyc                        # Start with NYC (HIGHNY-* series). Add more after calibration.
    series_ticker: HIGHNY            # Kalshi event series prefix for NYC daily high-temp markets
    forecast_std_f: 3.5              # Forecast uncertainty in °F (typical 1-day NWP MAE)
    min_edge_pct: 0.05               # 5% net edge required after Kalshi fee
    min_minutes_remaining: 30.0      # Don't enter with < 30 min left in market window
    min_confidence: 0.60             # Model must assign < 40% or > 60% to YES side
    refresh_interval_seconds: 1800   # Refresh Open-Meteo forecast every 30 minutes

  fomc:
    # FOMC Fed rate decision strategy — paper-only.
    # Compares 2yr yield curve signal (FRED) to Kalshi KXFEDDECISION market prices.
    # Only fires within days_before_meeting days of the next scheduled FOMC decision.
    # Reference: Federal Reserve working paper Jan 2026 — perfect day-before track record.
    # Data: FRED CSV endpoint (free, no API key: fred.stlouisfed.org/graph/fredgraph.csv)
    min_edge_pct: 0.05              # 5% net edge required after Kalshi fee
    min_minutes_remaining: 60.0     # Don't enter within 60 min of market close
    days_before_meeting: 14         # Only run in 14-day window before each FOMC date
    spread_hold_band: 0.25          # ±0.25% 2yr-DFF spread = hold regime
    cpi_adjustment: 0.08            # 8% shift between hold/cut on CPI trend
    fred_refresh_interval_seconds: 3600   # Refresh FRED data every hour

  whale_copy:                          # Polymarket only — inactive until off waitlist
    enabled: false
    min_win_rate: 0.62                 # Only copy whales with 62%+ win rate
    min_trades: 50                     # Must have 50+ trades to qualify
    copy_ratio: 0.02                   # Bet 2% of what they bet
    max_bet_usd: 5.00                  # Never exceed this regardless of copy_ratio

# ── Risk — hard floors enforced in code, config cannot override ──
risk:
  # Populated at runtime from USER_CONFIG.json
  starting_bankroll_usd: 50.00         # Matthew's starting bankroll

  # Per-trade caps (LOWER of usd and pct always applies)
  max_single_trade_usd: 5.00           # Hard cap: $5 per bet (Stage 1)
  max_single_trade_pct: 0.05           # Hard cap: 5% of bankroll

  # Daily limits
  daily_loss_limit_pct: 0.15           # Stop if down 15% of starting bankroll today
  daily_loss_resets_midnight: true     # Soft kill auto-resets at midnight

  # Consecutive loss protection
  consecutive_loss_pause: 5            # N losses in a row → pause
  consecutive_loss_cooldown_hours: 2   # Resume after this long

  # Rate limiting
  max_hourly_trades: 15                # Trades per hour before rate pause
  max_daily_bets_per_strategy: 5       # Max bets per strategy per UTC day (tax + quality gate)
                                       # btc_drift fires on 96% of windows — cap prevents tax churn
                                       # Set to 0 to disable (unlimited). Recommended: 3-5 for live.
  paper_slippage_ticks: 1              # 0 = no slippage, 1 = 1-tick adverse fill simulation (realistic paper mode)

  # Hard stops (require manual --reset-killswitch)
  hard_stop_loss_pct: 0.30             # Lose 30% total → HARD STOP
  min_bankroll_usd: 20.00             # Below $20 → HARD STOP

  # Auth failure protection
  max_auth_failures: 3                 # Consecutive auth failures → halt

# ── Stage-based sizing ───────────────────────────────────────────
stages:
  "1":
    range: [0, 100]
    max_bet_usd: 5.00
    max_pct: 0.05
  "2":
    range: [100, 250]
    max_bet_usd: 10.00
    max_pct: 0.05
  "3":
    range: [250, 9999]
    max_bet_usd: 15.00
    max_pct: 0.04
  upgrade_requires_profitable_stage: true
  upgrade_requires_min_live_trades: 30
  kelly_fraction: 0.25                 # Conservative 1/4 Kelly

# ── Dashboard ────────────────────────────────────────────────────
dashboard:
  port: 8501
  host: "127.0.0.1"                   # Localhost ONLY. Never 0.0.0.0.
  refresh_seconds: 30
  tip_rotation_seconds: 60
  max_open_positions_shown: 5
  max_recent_trades_shown: 10

# ── Storage ──────────────────────────────────────────────────────
storage:
  db_path: data/polybot.db

# ── Logging ──────────────────────────────────────────────────────
logging:
  level: INFO
  trades_dir: logs/trades
  errors_dir: logs/errors
  rotate_daily: true
